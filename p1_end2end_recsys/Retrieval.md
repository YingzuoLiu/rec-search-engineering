# Retrieval / Recall in Large-Scale Recommendation Systems

## 为什么要单独设计 Retrieval（候选召回）层？

在工业级推荐 / 搜索系统中，**候选召回（Retrieval / Recall）必须独立于排序（Ranking）阶段**，核心原因不是模型效果，而是**工程约束**。

### 1. 计算复杂度与延迟约束
- 全量候选规模通常是 **百万到亿级（N）**
- 精排模型一次打分即使只有 0.01~0.1 ms，O(N) 级别计算也会导致 **秒级甚至分钟级延迟**
- 通过 Retrieval 将候选空间缩小到 **K（几百~几千）**，后续复杂模型才能在 **毫秒级延迟预算**内运行

> 本质：不是 O(N) 和 O(K) 的数学区别，而是 **N 的数量级在工程上不可接受**

---

### 2. 目标函数不同
| 阶段 | 目标 |
|---|---|
| Retrieval / Recall | 高覆盖率（Recall@K）、不漏掉潜在相关候选 |
| Ranking | 精确排序（NDCG / CTR / CVR） |
| Re-rank | 业务约束、多样性、探索、稳定性 |

- Retrieval **宁可多、不求准**
- Ranking **求准但只在小候选集上做**

---

### 3. 工程解耦与系统稳定性
- Retrieval 通常要求：
  - 极高 QPS
  - 强缓存（embedding / 倒排 / user-item）
  - 可快速降级
- Ranking 通常要求：
  - 更复杂特征
  - 更重模型
  - 更高算力成本

解耦后可以：
- 单独扩容
- 独立发布
- 独立回滚（rollback）

---
从平台角度看，retrieval、ranking 和 re-rank 的拆分主要是出于工程约束。
Retrieval 或 recall 阶段负责将百万级以上的全量候选压缩到几百或几千，避免 O(N) 级别打分带来的延迟问题，因此更关注覆盖率和稳定性，ANN 检索通常就部署在这一层。
Ranking 阶段在受控的候选规模上运行更复杂的模型，以优化排序精度和业务指标。
Re-rank 则作为最终调控层，引入多样性、探索和业务规则，解决模型排序与实际业务目标之间的差距。
不同公司在命名上略有差异，但核心思想都是通过分阶段设计，让系统在规模扩展时依然可控、可回滚。
---
### 4、冷启动与业务目标的系统化处理

#### 1️⃣ 新用户（Cold Start）怎么做？

- 新用户没有历史行为
- 不能强行个性化
- 使用 **Cohort（分群）** 作为代理：
  - 城市
  - 时间段
  - 设备
- 用“相似人群的偏好”替代个人历史

**一句话**
> 冷启动阶段优先保证稳定性，个性化随行为逐步增强。

---

#### 2️⃣ 新商家曝光怎么做？（重点）

##### 正确做法
- 在 **Retrieval 阶段**：
  - 为新商家设计**独立召回路径**
  - 保证基础曝光
- 在 **Re-rank 阶段**：
  - 控制新商家比例
  - 做探索
  - 可快速回滚

##### 错误做法（雷区）
- 在 Ranking 里直接给新商家强行加权

---

### 5、为什么“改 Ranking 模型”是雷？

#### 本质区别

| 项目 | 改 Ranking 模型 | Re-rank 策略 |
|---|---|---|
| 改变模型语义 | ✅ | ❌ |
| 影响长期训练 | ✅ | ❌ |
| 是否可回滚 | ❌ | ✅ |
| 适合短期目标 | ❌ | ✅ |

**核心结论**
> 短期目标用策略（re-rank），长期目标用模型（ranking）。

---

### 6、短期冲 GMV 的真实含义

#### 什么是“短期冲 GMV”？
- 在特定时间窗口内（促销 / 财报 / 市场竞争）
- 暂时把成交金额放在第一优先级
- 接受一定的 CTR 或体验波动

#### 为什么不能直接改模型？

- 成本高  
- 不可逆  
- 污染长期模型能力  

---

###### 一、模型语义层面：你改的是「判断标准本身」

Ranking 模型的核心目标是学习：

> **P(user action | user, item, context)**  
> （用户在自然曝光下点击 / 下单的概率）

这意味着模型分数具有**明确语义**：

- 可以跨时间对比  
- 可以用于监控  
- 可以作为训练与评估的基准  

如果你在模型里“强行加权”：
```text 
final_score = model_score + bonus_if_new_merchant 
```

等价于告诉系统：

> “我明知道这个商家相关性低，但我要你排前面。”

结果是：

- 分数不再代表概率  
- 排名结果失去可解释性  
- 后续所有基于 score 的决策都被污染  

👉 这是在破坏模型的**「语义一致性」**。

---

##### 二、训练数据层面：策略会反向污染模型

真实系统中存在一个关键事实：

> **模型的训练数据来自于线上策略的输出结果**

如果你在 ranking 中强推某类商家：

- 这些商家会被大量曝光  
- 用户可能并不点击  

训练数据中出现大量：

- “被排前，但没点”的样本  

模型会学到：

> “这类商家 ≈ 低点击率”

长期后果：

- 新商家永远学不起来  
- 模型对探索对象产生系统性偏见  
- 需要额外去偏，复杂度飙升  

👉 这就是 **「策略污染训练数据」** 的问题。


#### 正确位置
> 短期 GMV 目标应落在 **Re-rank 层的策略调控**。

---

